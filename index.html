<!-- 
/*
 * @author     Flip
 * @package    ffMap
 * @version    1.0
 * @licenses	CC-BY-SA Creative Commons Namensnennung - Weitergabe unter gleichen Bedingungen 4.0 International Lizenz. https://creativecommons.org/licenses/by-sa/4.0/
 */ 
-->
<html lang="de">
	
	<head>
		<meta charset="utf-8">
		<title> Freifunk Map</title>
		
		<link rel="stylesheet" href="style.css">
		
		<!-- jQuerry -->
		<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
		<script src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
	
		<!-- jQuerry UI -->
		<link rel="stylesheet" href="jquery-ui-1.11.2.custom/jquery-ui.min.css">
		<script src="jquery-ui-1.11.2.custom/jquery-ui.min.js"></script>

		<!-- jleaflet -->
		<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
		<script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
		
		<link rel="stylesheet" href="Leaflet.markercluster/dist/MarkerCluster.css" />
		<link rel="stylesheet" href="Leaflet.markercluster/dist/MarkerCluster.Default.css" />
		<script src="Leaflet.markercluster/dist/leaflet.markercluster-src.js"></script>
		
		<!-- DataTables -->
		<link rel="stylesheet" type="text/css" href="DataTables/media/css/jquery.dataTables.min.css">
		<script type="text/javascript" charset="utf8" src="DataTables/media/js/jquery.dataTables.min.js"></script>
		
	</head>
	
	<body>
		<div id="tabs">
			<ul>
				<li><a href="#mapView">Map</a></li>
				<li><a href="#nodeList">Node List</a></li>
			</ul>
			
			<div id="mapView"> </div>
			<div id="nodeList">
				<p id="nodescount"> </p>
				<p id="nodesloc"> </p>
				<p id="nodeswifi"> </p>
				
				<table id="nodes" class="display" width="100%" cellspacing="0">
					<thead>
						<th class="hidden">Id</th><th>Node</th><th>Mac</th><th>Clients</th><th>Model</th><th>location</th><th>update</th><th>gluon</th><th>release</th>
					</thead>
				</table>
			</div>
		</div>
	</body>
</html>

<script>
function getAbsolutePath() {
    var loc = window.location;
    var pathName = loc.pathname.substring(0, loc.pathname.lastIndexOf('/') + 1);
    return loc.href.substring(0, loc.href.length - ((loc.pathname + loc.search + loc.hash).length - pathName.length));
}

	//get URL parameter (php $_GET Äquivalent)
function getParam(variable){ 
     var query = window.location.search.substring(1);  
     var vars = query.split("&"); 
      for (var i=0;i<vars.length;i++) {   
            var pair = vars[i].split("=");  
            if(pair[0] == variable){return pair[1];}
       }       
       return(false);
}

$(document).ready(function(){
	
	$( "#tabs"  ).tabs({ heightStyle: "content" });
	
	$( "#tabs" ).tabs(
	{
		beforeLoad: function( event, ui ) 
		{
			ui.jqXHR.error(function() {
				ui.panel.html("Couldn't load this tab. We'll try to fix this as soon as possible.");
			});
		}
	});
	
	var map = L.map('mapView').setView([48.7986, 9.2048], 11);
	
	L.control.scale().addTo(map);
	
	L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
	}).addTo(map);
	
	
	var markers = new L.MarkerClusterGroup();
	//var nodesList = [];
	var nodescount = 0;
	var nodesloc = 0;
	var nodeswifi = 0;

	try 
	{ 
		$.getJSON("./json/alfred-json-map.json",
		function(data) 
		{
			$.each( data, function( key, val ) 
			{	
				if(val.location != undefined)
				{
					var marker1 = L.marker([val.location.latitude, val.location.longitude]);
					marker1.bindPopup("<b>" + val.hostname + "</b><br>");
					marker1.on('mouseover', marker1.openPopup.bind(marker1));
					
					markers.addLayer(marker1);
					//nodesList.push(val);	
				}
				
				//Add node to  Node-List
				$( "#nodes" ).DataTable().row.add( {
					"id": 		val['node_id'],
			        "Node":    	val['hostname'],
			        "Mac": 		val['network']['mac'],
			        "Clients":  val['clients']['wifi'],
			        "Model": 	val['hardware']['model'],
			        "location": val['location'] == undefined ? 'no' : 'yes',
			        "update":  	val['software']['autoupdater']['branch'] + "  (" + val['software']['autoupdater']['enabled'] + ")",
			        "gluon": 	val['software']['firmware']['base'],
			        "release": 	val['software']['firmware']['release'],
			    } ).draw();
			    
			    nodescount++;
			    val['location'] == undefined ? null : nodesloc++;
			    nodeswifi += val['clients']['wifi'];
			});
			
			$("#nodescount").html("Nodes total: " + nodescount);
		    $("#nodesloc").html("Nodes with location: " + nodesloc);
		    $("#nodeswifi").html("Wifi-Clients: " + nodeswifi);
		});
	} 
	catch (err) 
	{
	    console.log(err);
	}
	
	map.addLayer(markers);
	
	
	// Managed Click for Location Info (get Koordinaten für neue Freifunk Nodes)
	var logo= L.control({
		    position : 'topleft'
		});
	logo.onAdd = function(map) {
	    this._div = L.DomUtil.create('div', 'myControl');
	    var img_log = '<div id="locationInfo"><img src=\"images/locationbar.png\"></img></div>';
	
	    this._div.innerHTML = img_log;
	    return this._div;
	
	};
	logo.addTo(map);

	$("#locationInfo").on("click", function() {
		map.addOneTimeEventListener("click", function (e) {
			function clickhandler(e) {
		      prompt("Breitengrad , Längengrad", e.latlng.lat + "," + e.latlng.lng);
		      map.off("click", clickhandler);
		   };
		   
		    var clickevent = map.on('click', clickhandler);
		});
	});
	
	//init NodeList
	$('#nodes').DataTable({
		paging: false,
		columns: [
        	{ data: "id", visible: false, },
        	{ data: "Node" },
            { data: "Mac" },
            { data: "Clients" },
            { data: "Model" },
            { data: "location" },
            { data: "update" },
            { data: "gluon" },
            { data: "release" }
        ]
	});
	
	//call this for specific tab
	var tabIndex = getParam('tab');
	if(tabIndex !== false) {
		$( "#tabs" ).tabs({ active: tabIndex });
	}
	
});
</script>
